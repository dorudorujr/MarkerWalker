# Claude Code Guide (CLAUDE.md)

このファイルは、Claude Code がこのリポジトリで作業する際の「前提」「方針」「禁止事項」「手順」を定義します。
曖昧な場合は推測せず質問してください。

---

## 1. このリポジトリの概要
- プロダクト名: **MarkerWalker**
- 目的:
  - **歩き専門のナビアプリ**
  - **案内地点の特徴を丁寧にわかりやすく説明**し、ユーザーが覚えやすい案内を提供する
- 主な技術:
  - **Swift 6 / SwiftUI / SPM (マルチモジュール構成)** / async/await
  - **TCA (導入予定)** / **Firebase (導入予定)** / **SwiftData (導入予定)**
- 重要な制約（プロダクト特性）:
  - 徒歩ナビとして **わかりやすい案内文/目印**が品質の中核
  - 位置情報などの **プライバシー配慮**が必須（ログ出力・送信の最小化）

---

## 2. Claude の基本動作ルール
### 2.1 まず"計画"を短く提示
- 変更前に **「何をどう変えるか」** を箇条書きで提示する
- 影響範囲が広い変更は、実装前に必ず確認を取る（"大きい変更"の定義は後述）

### 2.2 推測しない
- 不明点（仕様、命名、期待動作、既存ポリシー）は **質問** してから進める
- 既存の設計意図が読み取れない場合は、まず現状の読み取り結果を提示する

### 2.3 出力形式（原則）
- 変更提案 → 根拠 → 実装案 → 差分（またはファイル単位の置き換え） → 影響範囲/テスト観点
- コードはコピペで使える形にする（省略しない）

---

## 3. 作業してよい範囲 / 禁止事項
### 3.1 勝手にやってはいけないこと
- 公開APIの破壊的変更（呼び出し側の大量修正が必要なもの）
- 既存の命名規約/モジュール境界/ビルド構成を崩す変更
- 生成物（Generated/Build など）を直接編集する行為
- セキュリティや鍵情報に関わる変更（鍵の追加、ログ出力の追加など）を無断で行うこと

### 3.2 "大きい変更"の定義（事前確認が必要）
- 影響ファイル数が **10** を超える
- 新規モジュール追加、依存関係の追加/削除
- State/Action/Reducer の責務再配分（TCA設計に影響）
- ビルド設定 / CI / スクリプト周りの変更

---

## 4. コーディング規約（Swift / iOS）

### 4.1 Swift Style
- `guard` で早期return、ネストを浅く
- Optional は安全に扱い、強制アンラップは原則禁止
- 命名は Swift API Design Guidelines 準拠
- 変更が「挙動の変更」か「リファクタ」かを明確に

### 4.2 TCA（The Composable Architecture）方針
- **導入予定**
- 基本方針: **TCA公式のベストプラクティスに従う**
  - [公式ドキュメント](https://pointfreeco.github.io/swift-composable-architecture/)
- 決定事項があれば随時追記

### 4.3 SwiftData 方針
- **導入予定**
- 方針は今後決定次第追記

---

## 5. モジュール境界 / ディレクトリ方針
- 依存管理: **SPMのみ**
- **現状**: SPMマルチモジュール構成を導入済み
  - `MarkerWalker/Package.swift` で管理
  - 現在のモジュール: `AppFeature`
- **今後の予定**:
  - 以下のようなモジュール分割を予定:
    - `Clients`（外部I/OやAPI、Locationなど）
    - `Features`（TCA Feature群）
    - `UI`（共通View、DesignSystemなど）
- ルール:
  - 上位層 → 下位層 への依存のみ（循環は禁止）
  - I/Oは Clients に寄せ、Feature からは依存注入で利用

---

## 6. ビルド・テスト・Lint（暫定：未整備）
> まだ正式なコマンドが無いので、ここは後で確定する。

### 6.1 変更時の最低限チェック
- 変更した Feature のユニットテスト（可能なら追加）
- 影響画面の動作確認観点を列挙（UIならスクショ差分観点も）
- Firebase送信（ログ/イベント）を増やす場合は、送信内容の一覧を記載

---

## 7. Git / PR 運用
- ブランチ命名:
  - 開発: `feature/xxx`
  - バグ修正: `bugfix/xxx`
- コミット:
  - 小さく、目的が分かる粒度（規約は必要に応じて追加）
- PR:
  - 目的 / 背景 / 変更点 / テスト内容 / 影響範囲 を書く
  - "リファクタのみ"の場合は明記する
  - 位置情報・ログ・永続化（SwiftData）に触れる場合は、プライバシー影響を明記する

---

## 8. 仕様・要件が曖昧なときの質問テンプレ
Claude は次を確認してから実装すること。
- 期待する入出力（サンプルがあれば最優先）
- 既存挙動のどれが正で、どれがバグか
- 互換性（既存API/画面/データ）を維持する必要があるか
- ログ/計測/例外処理の方針
- 徒歩ナビの案内文（文言）に関わる場合は、文例（OK/NG）を確認する

---

## 9. セキュリティ / プライバシー
- 個人情報・機密情報をログに出さない（位置情報、ルート履歴、ユーザーID等）
- 鍵はリポジトリに直置きしない（必要時は手順を提案して確認を取る）
- Firebase（導入予定）のイベント/ログ追加は、収集データと目的を必ず明記する

---

## 10. メモ（リポジトリ固有）
TBD（決まり次第追記していく予定）
